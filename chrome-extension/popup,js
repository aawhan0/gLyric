const fetchBtn = document.getElementById('fetchLyrics');
const lyricsDiv = document.getElementById('lyrics');

fetchBtn.addEventListener('click', () => {
  lyricsDiv.textContent = "Loading lyrics...";   // Show loading state
  fetchBtn.disabled = true;                      // Disable button during fetch

  chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    const tab = tabs[0];
    if (!tab) {
      lyricsDiv.textContent = "No active tab found.";
      fetchBtn.disabled = false;
      return;
    }

    chrome.tabs.sendMessage(tab.id, { action: "getSongInfo" }, (response) => {
      if (response && response.song) {
        const queryParams = new URLSearchParams({
          artist: response.artist,
          song: response.song,
        }).toString();

        fetch(`http://127.0.0.1:8000/lyrics/?${queryParams}`)
          .then((res) => {
            if (!res.ok) throw new Error("Lyrics not found");
            return res.json();
          })
          .then((data) => {
            lyricsDiv.innerHTML = `
              <strong>${data.title}</strong> by <em>${data.artist}</em><br>
              <a href="${data.url}" target="_blank" rel="noopener noreferrer">View on Genius</a>
            `;
          })
          .catch(() => {
            lyricsDiv.textContent = "Lyrics not found.";
          })
          .finally(() => {
            fetchBtn.disabled = false;
          });
      } else {
        lyricsDiv.textContent = "Could not find song information.";
        fetchBtn.disabled = false;
      }
    });
  });
});
